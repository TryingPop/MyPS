# C#

## 난이도 : 다이아몬드 5

## 알고리즘 분류
  - 자료 구조
  - 트리
  - 세그먼트 트리
  - 분리 집합
  - 오프라인 쿼리
  - heavy-light 분할

## 제한조건
  - 시간 제한 : 5초
  - 메모리 제한 : 128 MB

## 문제
상근이는 "얼음을 꿈꾸다" 여행사의 사장이다. 이 여행사는 남극 근처의 섬 N개를 구매해 당일치기 여행을 제공하고 있다. 관광객들에게 가장 인기 있는 동물은 황제 펭귄으로 섬에서 쉽게 찾을 수 있다.<br/>
여행사는 점점 인기를 얻게 되었고, 이제 보트를 이용하는 것이 효율적이지 않은 상황까지 이르렀다. 상근이는 섬 사이에 다리를 건설해 관광객을 버스로 이동시키려고 한다. 상근이는 컴퓨터 프로그램을 이용해서 다리를 건설하는 과정을 관리하려고 한다.<br/>
섬은 1번부터 N번까지 번호가 매겨져 있다. 가장 처음에는 아무 다리도 없으며, 각 섬에 펭귄이 몇 마리 살고있는지는 모두 알고있다. 펭귄의 수는 변할 수 있다. 하지만, 항상 0보다 크거나 같고, 1000보다 작거나 같다.<br/>
상근이의 프로그램은 다음과 같은 세 가지 명령을 수행할 수 있어야 한다.<br/>

  - "bridge A B" - 섬 A와 B사이에 다리를 건설하는 명령이다. (A와 B는 다르다) 이전까지 지어진 다리를 이용해서 이동할 수 없는 경우에만 다리를 지어야 한다. 다리를 지어야 하면 "yes", 지을 필요가 없이 이미 이동할 수 있으면 "no"를 출력한다.
  - "penguins A X" - 섬 A에 살고있는 펭귄의 수를 다시 세보니 X마리가 되었다는 명령이다. 아무것도 출력할 필요가 없다.
  - "excursion A B" - 관광객들이 섬 A에서 시작해 B에서 끝나는 여행 경로를 이용하는 명령이다. A에서 B로 갈 수 있는 경우에는 이동하는 섬에 있는 모든 펭귄의 수를 구해 출력한다. (A와 B 포함) 이동할 수 없는 경우에는 "impossible"를 출력한다.

상근이의 프로그램을 작성하시오.<br/>


## 입력
첫째 줄에 섬의 수 N (1 ≤ N ≤ 30,000)이 주어진다.<br/>
둘째 줄에는 각 섬에 있는 펭귄의 수가 주어진다.<br/>
셋째 줄에는 명령의 개수 Q (1 ≤ Q ≤ 300,000)가 주어진다.<br/>
다음 Q개 줄에는 문제에서 주어진 명령 중 하나가 주어진다.<br/>


## 출력
"bridge"나 "excursion" 명령이 주어질 때 마다 출력한다.<br/>


## 예제 입력
5<br/>
4 2 4 5 6<br/>
10<br/>
excursion 1 1<br/>
excursion 1 2<br/>
bridge 1 2<br/>
excursion 1 2<br/>
bridge 3 4<br/>
bridge 3 5<br/>
excursion 4 5<br/>
bridge 1 3<br/>
excursion 2 4<br/>
excursion 2 5<br/>


## 예제 출력
4<br/>
impossible<br/>
yes<br/>
6<br/>
yes<br/>
yes<br/>
15<br/>
yes<br/>
15<br/>
16<br/>


## 풀이
다리 건설은 두 섬이 이어지지 않은 경우에만 이어준다.<br/>
그러면 이어진 섬들을 그래프로 나타내면 각각이 트리가 된다.<br/>


쿼리를 입력과 동시에 진행하기에는 A 섬에서 B 섬에 있는 경로상에 펭귄을 조사해야 한다.<br/>
그래서 매번 이동하기에는 쿼리와 섬이 많다.<br/>
그래서 쿼리를 입력받고 재배치하여 처리하는 오프라인 쿼리로 해결한다.<br/>


먼저 쿼리를 진행하면서 해당 섬으로 다리를 놓을 수 있는지 이동할 수 있는지는 유니온-파인드 알고리즘을 이용해 바로 판별이 가능하다.<br/>
그래서 입력과 동시에 다리를 놓을 수 있는가와 이동할 수 있는지를 판별한다.<br/>
남은 쿼리는 A에서 B로 이동할 수 있는 경우만 있다.<br/>


A에서 B로 가는 경로의 모든 섬(노드)들을 관리해야 하기에 HLD 알고리즘을 써서 인덱스를 관리했다.<br/>
그리고 인덱스에 따른 펭귄 수를 보관할 범위의 누적합을 저장하는 세그먼트 트리를 관리해 문제를 해결했다.<br/>


## 문제 링크
https://www.acmicpc.net/problem/2927